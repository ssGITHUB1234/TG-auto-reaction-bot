<!doctype html>
<html>
<head><meta charset="utf-8"><title>User Dashboard - TG-react</title></head>
<body>
  <h1>User Dashboard</h1>
  <div>
    <label>Your username: <input id="owner" value="" /></label>
    <button id="fetch">Fetch my bots</button>
  </div>
  <div id="bots"></div>

  <script>
    async function fetchBots(owner){
      const r = await fetch('/api/bots?owner=' + encodeURIComponent(owner));
      const j = await r.json();
      return j.bots;
    }
    document.getElementById('fetch').addEventListener('click', async ()=>{
      const owner = document.getElementById('owner').value.trim();
      if(!owner) return alert('Enter your owner name (username)');
      const bots = await fetchBots(owner);
      const container = document.getElementById('bots');
      container.innerHTML = '';
      bots.forEach(b=>{
        const div = document.createElement('div');
        div.innerHTML = `<h3>${b.title || 'untitled'} (id:${b.id})</h3>
          <p>enabled: ${b.enabled}</p>
          <p>force join: ${b.force_join_channel || '-'}</p>
          <button data-id="${b.id}" class="toggle">${b.enabled ? 'Turn off' : 'Turn on'}</button>
          <button data-id="${b.id}" class="stats">Stats</button>
          <button data-id="${b.id}" class="broadcast">Broadcast</button>
        `;
        container.appendChild(div);
      });
    });

    document.getElementById('bots').addEventListener('click', async (e)=>{
      const id = e.target.dataset.id;
      if(!id) return;
      if(e.target.classList.contains('toggle')){
        const owner = document.getElementById('owner').value.trim();
        const enable = e.target.textContent.includes('Turn on');
        await fetch('/api/bots/' + id + '/toggle', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ owner, enable })
        });
        alert('Toggled. Refreshing...');
        document.getElementById('fetch').click();
      } else if(e.target.classList.contains('stats')){
        const r = await fetch('/api/bots/' + id + '/stats');
        const j = await r.json();
        alert('Total users: ' + j.stats.totalUsers);
      } else if(e.target.classList.contains('broadcast')){
        const msg = prompt('Message to broadcast:');
        if(!msg) return;
        const owner = document.getElementById('owner').value.trim();
        const r = await fetch('/api/bots/' + id + '/broadcast', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ message: msg, owner })
        });
        const j = await r.json();
        if (j.ok) alert('Broadcast sent to ' + j.sent + '/' + j.attempted);
        else alert('Error: ' + JSON.stringify(j));
      }
    });
  </script>
</body>
</html>
